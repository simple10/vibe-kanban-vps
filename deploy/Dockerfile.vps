# =============================================================================
# vibe-kanban VPS — runtime image with npx-based install
# No build stage needed: vibe-kanban is installed from npm at image build time.
# =============================================================================
FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Base runtime packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    wget \
    git \
    tini \
    openssh-client \
    openssh-server \
    gnupg \
    lsb-release \
    gosu \
    && rm -rf /var/lib/apt/lists/*

# Install Docker CE (agents may need Docker inside the sysbox container)
RUN install -m 0755 -d /etc/apt/keyrings && \
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc && \
    chmod a+r /etc/apt/keyrings/docker.asc && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] \
    https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" \
    > /etc/apt/sources.list.d/docker.list && \
    apt-get update && apt-get install -y --no-install-recommends \
    docker-ce \
    docker-ce-cli \
    containerd.io \
    && rm -rf /var/lib/apt/lists/*

# Install Node.js 24.x (needed for vibe-kanban + npx-based agent spawning)
RUN curl -fsSL https://deb.nodesource.com/setup_24.x | bash - && \
    apt-get install -y --no-install-recommends nodejs && \
    rm -rf /var/lib/apt/lists/*

# Install GitHub CLI (used by vibe-kanban for PR creation via gh auth login)
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    -o /usr/share/keyrings/githubcli-archive-keyring.gpg && \
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] \
    https://cli.github.com/packages stable main" \
    > /etc/apt/sources.list.d/github-cli.list && \
    apt-get update && apt-get install -y --no-install-recommends gh && \
    rm -rf /var/lib/apt/lists/*

# Install vibe-kanban from npm (includes pre-built frontend with Virtuoso license)
RUN npm install -g vibe-kanban

# Create non-root user for vibe-kanban (Claude Code refuses --dangerously-skip-permissions as root)
RUN groupadd -r vkuser && \
    useradd -r -g vkuser -G docker -m -s /bin/bash vkuser

# Create required directories owned by vkuser
# Home subdirs are created by entrypoint.sh (the bind mount shadows image contents)
RUN mkdir -p /repos /var/tmp/vibe-kanban/worktrees && \
    chown -R vkuser:vkuser /repos /var/tmp/vibe-kanban /home/vkuser

# Configure sshd for IDE remote access (opt-in via VK_IDE_SSH=true)
RUN mkdir -p /run/sshd /etc/ssh/sshd_host_keys && \
    printf '%s\n' \
    'Port 2222' \
    'HostKey /etc/ssh/sshd_host_keys/ssh_host_ed25519_key' \
    'HostKey /etc/ssh/sshd_host_keys/ssh_host_rsa_key' \
    'PasswordAuthentication no' \
    'KbdInteractiveAuthentication no' \
    'AllowUsers vkuser' \
    'AllowTcpForwarding yes' \
    'Subsystem sftp /usr/lib/openssh/sftp-server' \
    > /etc/ssh/sshd_config.d/vk-ide.conf

# Copy entrypoint
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

# Runtime environment
ENV HOST=0.0.0.0
ENV PORT=3000
EXPOSE 3000
EXPOSE 2222

WORKDIR /repos

# Health check — hit the server root
HEALTHCHECK --interval=30s --timeout=3s --start-period=60s --retries=3 \
    CMD wget --quiet --tries=1 --spider "http://localhost:${PORT:-3000}" || exit 1

# tini as PID 1, then our entrypoint
ENTRYPOINT ["/usr/bin/tini", "--"]
CMD ["/usr/local/bin/entrypoint.sh"]
